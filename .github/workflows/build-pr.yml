name: build-pr
run-name: "build ${{ inputs.packages }} from ${{ inputs.repo }}#${{ inputs.pr-number }}"

permissions: {}

on:
  workflow_dispatch:
    inputs:
      repo:
        description: "GitHub repository (owner/name)"
        required: true
        type: string

      pr-number:
        description: "Pull Request number"
        required: true
        type: number

      packages:
        description: "Nix packages or flake attributes to build"
        required: true
        type: string

      x86_64-linux:
        description: "Build on x86_64-linux"
        required: true
        type: boolean
        default: true

      aarch64-linux:
        description: "Build on aarch64-linux"
        required: true
        type: boolean
        default: true

      x86_64-darwin:
        description: "Build on x86_64-darwin"
        required: true
        type: choice
        default: yes_sandbox_relaxed
        options:
          - "no"
          - yes_sandbox_false
          - yes_sandbox_relaxed
          - yes_sandbox_true

      aarch64-darwin:
        description: "Build on aarch64-darwin"
        required: true
        type: choice
        default: yes_sandbox_relaxed
        options:
          - "no"
          - yes_sandbox_false
          - yes_sandbox_relaxed
          - yes_sandbox_true

      upterm:
        description: "Start upterm session after nix build"
        required: true
        type: boolean
        default: false

      post-result:
        description: "Post Result"
        required: true
        type: boolean
        default: true

      upload-cachix:
        description: "Upload to Cachix"
        required: true
        type: boolean
        default: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        system:
          - x86_64-linux
          - aarch64-linux
          - x86_64-darwin
          - aarch64-darwin
        exclude:
          - system: ${{ !inputs.x86_64-linux && 'x86_64-linux' || '' }}
          - system: ${{ !inputs.aarch64-linux && 'aarch64-linux' || '' }}
          - system: ${{ inputs.x86_64-darwin == 'no' && 'x86_64-darwin' || '' }}
          - system: ${{ inputs.aarch64-darwin == 'no' && 'aarch64-darwin' || '' }}

    runs-on: >-
      ${{ (matrix.system == 'x86_64-linux' && 'ubuntu-latest')
      || (matrix.system == 'aarch64-linux' && 'ubuntu-24.04-arm')
      || (matrix.system == 'x86_64-darwin' && 'macos-latest')
      || (matrix.system == 'aarch64-darwin' && 'macos-latest') }}

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v6
        with:
          path: gha

      - name: Setup Nix
        uses: ./gha/.github/actions/setup-nix
        with:
          extra-nix-config: ${{ vars.EXTRA_NIX_CONFIG }}
          system: ${{ matrix.system }}
          sandbox: ${{
            (matrix.system == 'x86_64-darwin' && inputs.x86_64-darwin == 'yes_sandbox_false'
            || matrix.system == 'aarch64-darwin' && inputs.aarch64-darwin == 'yes_sandbox_false') && 'false'
            || (matrix.system == 'x86_64-darwin' && inputs.x86_64-darwin == 'yes_sandbox_relaxed'
            || matrix.system == 'aarch64-darwin' && inputs.aarch64-darwin == 'yes_sandbox_relaxed') && 'relaxed'
            || 'true' }}

      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          repository: ${{ inputs.repo }}
          ref: refs/pull/${{ inputs.pr-number }}/head
          fetch-depth: 0
          path: src

      - name: Nix build
        id: nix-build
        working-directory: src
        run: |
          nix build \
            --keep-going \
            -L \
            --no-link \
            .#${{ inputs.packages }}

      - name: Set GITHUB_TOKEN for upterm
        if: ${{ inputs.upterm }}
        run: echo "GITHUB_TOKEN=${GITHUB_TOKEN}" >> "$GITHUB_ENV"
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Start upterm session
        if: ${{ inputs.upterm }}
        uses: owenthereal/action-upterm@v1
        with:
          limit-access-to-actor: true
        continue-on-error: true

      - name: Generate build report
        id: report
        if: ${{ always() }} # 即使构建失败也要运行
        run: |
          # 检查上一步（nix build）的执行结果
          if [ "${{ steps.nix-build.outcome }}" == "success" ] || [ "${{ steps.nix-build.conclusion }}" == "success" ]; then
            BUILD_SUCCESSFUL="true"
          else
            BUILD_SUCCESSFUL="false"
          fi

          # 创建报告内容
          cat << EOF > build_report_${{ matrix.system }}.md
          ### \`${{ matrix.system }}\`
          - Package(s): \`${{ inputs.packages }}\`
          - Status: $(if [[ "$BUILD_SUCCESSFUL" == "true" ]]; then echo ":white_check_mark: Success"; else echo ":x: Failed"; fi)
          - Logs: See [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          EOF

          # 创建 JSON 报告
          jq -n --arg md "$(cat build_report_${{ matrix.system }}.md)" \
             --arg successful "$BUILD_SUCCESSFUL" \
             --arg system "${{ matrix.system }}" \
             '{"md": $md, "successful": ($successful | test("true")), "system": $system}' > build_report_${{ matrix.system }}.json

          echo "successful=$BUILD_SUCCESSFUL" >> "$GITHUB_OUTPUT"

      - uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: build_report_${{ matrix.system }}.json
          path: build_report_${{ matrix.system }}.json
          if-no-files-found: error

  report:
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ always() && inputs.post-result }}
    outputs:
      success: ${{ steps.report.outputs.success }}

    steps:
      - uses: actions/download-artifact@v7
        with:
          merge-multiple: true

      - name: Generate combined report
        id: report
        run: |
          echo -e "## Build Results\n" >> report.md
          echo -e "Generated using [\`nixpkgs-review-gha\`](https://github.com/Defelo/nixpkgs-review-gha)\n" >> report.md
          echo -e "Command: \`nix build .#${{ inputs.packages }}\`" >> report.md
          echo -e "Repository: ${{ inputs.repo }}" >> report.md
          echo -e "PR: #${{ inputs.pr-number }}" >> report.md
          echo -e "Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n" >> report.md

          # 合并所有系统的报告
          for report_file in build_report_*.json; do
            if [[ -f "$report_file" ]]; then
              jq -r '.md' "$report_file" >> report.md
              echo "" >> report.md
            fi
          done

          # 检查是否所有构建都成功
          all_successful=$(jq -s 'all(.[].successful)' build_report_*.json 2>/dev/null || echo "false")
          echo "success=$all_successful" >> "$GITHUB_OUTPUT"

          cat report.md
          sed -e '1s|$| for [#'"${{ inputs.pr-number }}"'](${{ github.server_url }}/${{ inputs.repo }}/pull/'"${{ inputs.pr-number }}"')|' report.md >> $GITHUB_STEP_SUMMARY

      - uses: actions/upload-artifact@v6
        if: ${{ always() }}
        with:
          name: report.md
          path: report.md
          if-no-files-found: error

  post-result:
    runs-on: ubuntu-latest
    needs: [report]
    if: ${{ always() && inputs.post-result }}
    steps:
      - uses: actions/download-artifact@v7
        with:
          name: report.md

      - name: Post comment
        run: |
          if [[ -n "$GH_TOKEN" ]]; then
            gh pr comment ${{ inputs.pr-number }} -R ${{ inputs.repo }} -F report.md
          fi
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  upload-cachix:
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ needs.build.result == 'success' && inputs.upload-cachix }}
    steps:
      - name: Checkout PR
        uses: actions/checkout@v6
        with:
          repository: ${{ inputs.repo }}
          ref: refs/pull/${{ inputs.pr-number }}/head
          fetch-depth: 0
          path: src

      - name: Checkout workflow repo
        uses: actions/checkout@v6
        with:
          path: gha

      - name: Setup Nix
        uses: ./gha/.github/actions/setup-nix
        with:
          extra-nix-config: ${{ vars.EXTRA_NIX_CONFIG }}
          system: x86_64-linux
          sandbox: true

      - name: Install cachix
        run: |
          nix-env -iA cachix -f https://cachix.org/api/v1/install

      - name: Authenticate with Cachix
        run: |
          cachix authtoken ${{ secrets.CACHIX_AUTH_TOKEN }}
        if: ${{ secrets.CACHIX_AUTH_TOKEN != '' }}

      - name: Upload to Cachix
        working-directory: src
        if: ${{ secrets.CACHIX_AUTH_TOKEN != '' }}
        run: |
          nix build .#${{ inputs.packages }} -L
          cachix push loneros $(nix path-info .#${{ inputs.packages }})
